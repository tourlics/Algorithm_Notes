<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />

    <script src='http://libs.baidu.com/jquery/1.7.2/jquery.min.js'></script>
    <script type="text/javascript">

        var AllBlogsObj = [];
        var blogObj = [];

        function readFile(input) {
            AllBlogsObj = [];
            $("#blogs").html("");
            //支持chrome IE10
            if (window.FileReader) {
                for (var i = 0; i < input.files.length; i++) {
                    var file = input.files[i];
                    filename = file.name.split(".")[0];
                    var reader = new FileReader();
                    reader.onload = function () { console.log("读取完成"); }
                    reader.onloadend = function () { console.log("读取结束"); bindTitle(this.result); }
                    //reader.onprogress = function (e) { $("#Progress").value = (e.loaded / file.size )* 100 }
                    reader.readAsText(input.files[i]);
                }
            }
            //支持IE 7 8 9 10
            else if (typeof window.ActiveXObject != 'undefined') {
                var xmlDoc;
                xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                xmlDoc.async = false;
                xmlDoc.load(input.value);
                console.log(xmlDoc.xml);
            }
            //支持FF
            else if (document.implementation && document.implementation.createDocument) {
                var xmlDoc;
                xmlDoc = document.implementation.createDocument("", "", null);
                xmlDoc.async = false;
                xmlDoc.load(input.value);
                console.log(xmlDoc.xml);
            } else {
                alert('error');
            }
        }

        function bindTitle(htmlStr) {
            const regex = /<item>(<title>.*<\/title>)<link>(.*)<\/link>.*<pubDate>(.*)<\/pubDate>.*<!\[CDATA\[([\w,\W]*?)\]\]>/gim;
            let m;
            while ((m = regex.exec(htmlStr)) !== null) {
                if (m.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
                var k = new Date(m[3]).Format('yyyy-MM-dd hh:mm:ss');
                var index = AllBlogsObj.push({ k, m });
            }
            ShowTitle($("#txtSearch").val("").val());
        }

        function ShowTitle(filterTxt) {
            var html = "";
            filterTxt = filterTxt != null ? filterTxt : "";
            var reg = new RegExp(filterTxt, "gim");
            if (filterTxt.length > 0)
                reg.compile("(" + filterTxt.trim().replace(/ +/gi, '|') + ")", "igm");
            var tmpBlogTitle = tmpBlogBody = [];
            blogObj = [];

            //blogObj = AllBlogsObj.filter(x => { x.m[1] = x.m[1].replace(reg, "<font color='red'>" + filterTxt + "</font>"); return reg.test(x.m[1]) || reg.test(x.m[1]) });
            if (filterTxt.length > 0) {
                AllBlogsObj.filter(x => { reg.lastIndex = 0; return reg.test(x.m[1]); }).forEach((x) => {
                    var k = x.k;
                    var v = {};
                    v.title = filterTxt.length > 0 ? x.m[1].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; }) : x.m[1];
                    v.url = x.m[2];
                    v.publishTime = x.m[3];
                    v.body = filterTxt.length > 0 ? x.m[4].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; }) : x.m[4];
                    //blogObj.push({ k, v });
                    blogObj.push({
                        k: x.k, v: {
                            title: x.m[1].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; }),
                            url: x.m[2], publishTime: x.m[3],
                            body: x.m[4].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; })
                        }
                    });
                });
                AllBlogsObj.filter(x => { reg.lastIndex = 0; return reg.test(x.m[4]); }).forEach((x) => {
                    //测试使用
                    var k = x.k;
                    var v = {};
                    v.title = x.m[1];
                    v.url = x.m[2];
                    v.publishTime = x.m[3];
                    v.body = filterTxt.length > 0 ? x.m[4].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; }) : x.m[4];
                    //blogObj.push({ k, v });
                    if (blogObj.findIndex(item => { return item.k == x.k }) < 0)
                        blogObj.push({
                            k: x.k, v: {
                                title: x.m[1], url: x.m[2], publishTime: x.m[3],
                                body: x.m[4].replace(reg, function (w) { return "<span style='color: red;'><strong>" + w + "</strong></span>"; })
                            }
                        });
                });
            }
            else {
                AllBlogsObj.forEach((x) => { blogObj.push({ k: x.k, v: { title: x.m[1], url: x.m[2], publishTime: x.m[3], body: x.m[4] } }); });
                //按日期从小到大排序
                blogObj.sort((a, b) => { return b.k.replace(/-/g, "").replace(/:/g, "").replace(/ /g, "") - a.k.replace(/-/g, "").replace(/:/g, "").replace(/ /g, ""); });
            }
            $("#blogs").html("");
            for (var it in blogObj) {
                //console.log("key: " + it.k + " ,value: " + it.v);
                let n = blogObj[it];
                var item = "<div>" + "<a href='#' onclick=\"showBlog('" + it + "')\" target='_blank'>"
                item += n.v.title.replace(/title/g, "span") + "</a>";
                item += "    <span>【发布时间：" + new Date(n.v.publishTime).Format("yyyy-MM-dd hh:mm:ss") + "】</span>";
                item += "    <span><a href='" + n.v.url + "' target='_blank'>阅读原文</a>";
                item += "</div>";
                html += item;
            }
            $("#blogs").append(html);
            $("#res").html("共解析：" + blogObj.length + " 篇文章");
        }

        function showBlog(str) {
            wo = window.open("");
            wo.document.write("<HTML>")
            wo.document.write("<HEAD><TITLE>" + blogObj[str].v.title.substr(7, blogObj[str].v.title.length - 15) + "</TITLE></HEAD>")
            wo.document.write("<BODY BGCOLOR=#ffffff>")
            wo.document.write(blogObj[str].v.title.replace(/title/g, "h1"))
            wo.document.write(blogObj[str].v.body)
            wo.document.write("</BODY>")
            wo.document.write("</HTML>")
            wo.document.close()
        }

        function searchText() {
            ShowTitle($("#txtSearch").val());
        }

        // 对Date的扩展，将 Date 转化为指定格式的String
        // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
        // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
        // 例子：
        // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
        // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1,                     //月份
                "d+": this.getDate(),                          //日
                "h+": this.getHours(),                         //小时
                "m+": this.getMinutes(),                       //分
                "s+": this.getSeconds(),                     //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()                     //毫秒
            };
            if (/(y+)/.test(fmt))
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt))
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }

        $(document).ready(function (e) {
            $(this).keydown(function (e) {
                if (e.which == "13") {
                    console.log(123);
                    searchText();//触发该事件
                }
            })
        });

    </script>

</head>

<body>

    <fieldset>
        <legend>管理信息</legend>
        <input type="file" id="cnblogsFile" multiple="multiple" onchange="readFile(this)" />      
        <span id="res"></span>
        <span style="position:absolute; left:500px">
            <input type="text" id="txtSearch" style="width:300px;" />
            <input type="button" onclick="searchText()" value="搜索" />
        </span>
    </fieldset>
    <div id="blogs">
    </div>
</body>
</html>